- VARIABLE BIND (DE ENTORNO O GLOBALES)
VARIABLE B_COLACION NUMBER;
VARIABLE B_MOVILIZACION1 NUMBER;
VARIABLE B_MOVILIZACION2 NUMBER;

DECLARE
  V_MIN                 NUMBER;
  V_MAX                 NUMBER;

  V_NOMBRE              VENDEDOR.VENDEDOR_NOMBRE%TYPE;
  V_CANTIDAD_VENTAS     NUMBER;
  V_BONO_VENTAS         NUMBER;
  
  V_SUELDO_BRUTO        VENDEDOR.SUELDO_BRUTO%TYPE;
  
  V_MOV_PORCENTAJE      NUMBER;
  V_MOV_BONO            NUMBER;
  
  V_SUCURSAL_ID         VENDEDOR.FK_SUCURSAL_ID%TYPE;
  V_SUCURSAL_NOMBRE     SUCURSAL.SUCURSAL_NOMBRE%TYPE;
  
  V_FECHA_CONTRATO      VENDEDOR.VENDEDOR_FECHA_CONTRATO%TYPE;
  V_CANTIDAD_ANIOS      NUMBER;
  V_ANIOS_PORCENTAJE    NUMBER;
  V_ANIOS_BONO          NUMBER;
  
  V_ERROR_CODIGO        VARCHAR2(200);
  V_ERROR_DESCRIPCION   VARCHAR2(200);
  
  V_ZONA                SUCURSAL.ZONA_ID%TYPE;
  V_DESCUENTO_ZONA      NUMBER;
BEGIN
  :B_COLACION := 58000;
  :B_MOVILIZACION1 := 15000;
  :B_MOVILIZACION2 := 20000;
  
  DELETE FROM HABERES_MES;
  
  SELECT MIN(VENDEDOR_ID), MAX(VENDEDOR_ID)
  INTO  V_MIN, V_MAX
  FROM  VENDEDOR;

  WHILE V_MIN <= V_MAX LOOP
    SELECT VEND.VENDEDOR_NOMBRE,
           VEND.SUELDO_BRUTO, 
           VEND.FK_SUCURSAL_ID,
           VEND.VENDEDOR_FECHA_CONTRATO,
           COUNT(VENT.VENTA_ID)
    INTO   V_NOMBRE,
           V_SUELDO_BRUTO,
           V_SUCURSAL_ID,
           V_FECHA_CONTRATO,
           V_CANTIDAD_VENTAS
    FROM   VENDEDOR VEND
           LEFT JOIN VENTA VENT ON VEND.VENDEDOR_ID = VENT.FK_VENDEDOR_ID
    WHERE  VEND.VENDEDOR_ID = V_MIN
    GROUP  BY VEND.VENDEDOR_NOMBRE,
              VEND.SUELDO_BRUTO,
              VEND.FK_SUCURSAL_ID,
              VEND.VENDEDOR_FECHA_CONTRATO;
    -- :(
    /* 
    IF V_CANTIDAD_VENTAS >= 1 AND V_CANTIDAD_VENTAS <= 2 THEN
      V_BONO_VENTAS := 10000;
    ELSIF V_CANTIDAD_VENTAS >= 3 AND V_CANTIDAD_VENTAS <= 5 THEN
      V_BONO_VENTAS := 15000;
    ELSIF V_CANTIDAD_VENTAS >= 6 AND V_CANTIDAD_VENTAS <= 10 THEN
      V_BONO_VENTAS := 20000;
    ELSIF V_CANTIDAD_VENTAS >= 11 AND V_CANTIDAD_VENTAS <= 99 THEN
      V_BONO_VENTAS := 25000;
    END IF;
    */

    -- :)
    IF V_CANTIDAD_VENTAS > 0 THEN
      SELECT BONO INTO V_BONO_VENTAS
      FROM BONO_VENTAS
      WHERE V_CANTIDAD_VENTAS 
      BETWEEN CANT_INFERIOR AND CANT_SUPERIOR;
    ELSE 
      V_BONO_VENTAS := 0;
    END IF;
    
    SELECT VALOR_PORCENTAJE INTO V_MOV_PORCENTAJE
    FROM RANGO_SUELDO
    WHERE V_SUELDO_BRUTO BETWEEN VALOR_INFERIOR AND VALOR_SUPERIOR;
    

    
    V_MOV_BONO := V_SUELDO_BRUTO * V_MOV_PORCENTAJE / 100;
    
    IF V_CANTIDAD_VENTAS >= 1 AND V_CANTIDAD_VENTAS <= 3 THEN
        V_MOV_BONO := V_MOV_BONO + :B_MOVILIZACION1;
    ELSIF V_CANTIDAD_VENTAS > 3 THEN
        V_MOV_BONO := V_MOV_BONO + :B_MOVILIZACION2;
    END IF; 
    
    SELECT UPPER(SUCURSAL_NOMBRE) INTO V_SUCURSAL_NOMBRE
    FROM SUCURSAL
    WHERE SUCURSAL_ID = V_SUCURSAL_ID;
    
    IF V_SUCURSAL_NOMBRE = 'LA FLORIDA' OR
       V_SUCURSAL_NOMBRE = 'APOQUINDO' OR
       V_SUCURSAL_NOMBRE = 'INDEPENDENCIA' THEN
       
       V_MOV_BONO := V_MOV_BONO + 15000;
       
    END IF;
    
    V_CANTIDAD_ANIOS := TRUNC(MONTHS_BETWEEN(SYSDATE, V_FECHA_CONTRATO)/12);
    
    SELECT VALOR_PORCENTAJE INTO V_ANIOS_PORCENTAJE
    FROM ANIOS_CONTRATO
    WHERE V_CANTIDAD_ANIOS BETWEEN VALOR_INFERIOR AND VALOR_SUPERIOR;
    
    V_ANIOS_BONO := V_SUELDO_BRUTO * V_ANIOS_PORCENTAJE / 100;
    
    INSERT INTO HABERES_MES VALUES (
        V_MIN,
        V_NOMBRE,
        V_CANTIDAD_VENTAS,
        V_BONO_VENTAS,
        V_SUELDO_BRUTO,
        V_MOV_BONO,
        :B_COLACION,
        V_ANIOS_BONO,
        TO_CHAR(SYSDATE, 'MM/YYYY')
    );
    
    -- CALCULO DE DESCUENTOS
    -- DESCUENTO POR ZONA
    SELECT ZONA_ID INTO V_ZONA
    FROM SUCURSAL
    WHERE SUCURSAL_ID = V_SUCURSAL_ID;
    
    IF V_ZONA = 'Z001' THEN
        V_DESCUENTO_ZONA := V_SUELDO_BRUTO * 5 / 100;
    ELSE
        V_DESCUENTO_ZONA := 0;
    END IF;

    V_MIN := V_MIN + 1;
  END LOOP;
EXCEPTION
    WHEN OTHERS THEN
        V_ERROR_CODIGO := SQLCODE;
        V_ERROR_DESCRIPCION := SQLERRM;        
END;

SELECT
    vendedor_id,
    vendedor_nombre,
    vendedor_cantidad_ventas,
    vendedor_bono_ventas,
    vendedor_sueldo_bruto,
    vendedor_bono_movilizacion,
    vendedor_colacion,
    vendedor_bono_anios,
    mes_anio
FROM
    haberes_mes;
DBMS_OUTPUT.PUT_LINE(V_MIN);
SELECT * FROM HABERES_MES;
DELETE FROM HABERES_MES;

 SELECT ZONA_ID 
    FROM SUCURSAL
    WHERE SUCURSAL_ID = V_SUCURSAL_ID;
